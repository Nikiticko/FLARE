name: Auto deploy to server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy backend via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            echo "ğŸš€ Start deploy"

            cd /var/www/shkila

            echo "ğŸ“¦ Update code"
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ Activate venv"
            source venv/bin/activate

            echo "ğŸ“š Install requirements"
            pip install -r requirements.txt

            echo "ğŸ—„ï¸ Django migrate"
            cd back/school
            python manage.py migrate

            echo "ğŸ§¹ Collect static"
            python manage.py collectstatic --noinput --clear

            echo "ğŸ” Restart service"
            systemctl restart shkila

            echo "âœ… Deploy finished"
